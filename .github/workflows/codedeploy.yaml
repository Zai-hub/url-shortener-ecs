name: Trigger CodeDeploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      image_tag:
        required: false

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  codedeploy:
    name: Deploy CodeDeploy
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: Build AppSpec and trigger CodeDeploy
      env:
        CLUSTER: url-shortener-ecs-cluster
        SERVICE: url-shortener-ecs-service
        CONTAINER_NAME: url-shortener-ecs-container
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
      run: |
          set -euo pipefail

                  TAG="${{ inputs.image_tag }}"
                  if [ -z "$TAG" ]; then TAG="${GITHUB_SHA}"; fi

                  IMAGE_URI="${{ steps.login-ecr.outputs.registry }}/${ECR_REPOSITORY}:${TAG}"
                  echo "Deploying image: $IMAGE_URI"

                  CURRENT_TD_ARN=$(aws ecs describe-services \
                    --cluster "$CLUSTER" \
                    --services "$SERVICE" \
                    --query "services[0].taskDefinition" \
                    --output text)

                  aws ecs describe-task-definition \
                    --task-definition "$CURRENT_TD_ARN" \
                    --query "taskDefinition" \
                    --output json > td.json

                  jq --arg IMG "$IMAGE_URI" --arg NAME "$CONTAINER_NAME" '
                    .containerDefinitions |= map(if .name == $NAME then .image = $IMG else . end)
                    | del(.taskDefinitionArn,.revision,.status,.requiresAttributes,.compatibilities,.registeredAt,.registeredBy)
                  ' td.json > td-new.json

                  NEW_TD_ARN=$(aws ecs register-task-definition \
                    --cli-input-json file://td-new.json \
                    --query "taskDefinition.taskDefinitionArn" \
                    --output text)

          printf '%s\n' \
          'version: 0.0' \
          'Resources:' \
          '- TargetService:' \
          '    Type: AWS::ECS::Service' \
          '    Properties:' \ 
          "      TaskDefinition: $NEW_TD_ARN" \
          '      LoadBalancerInfo:' \
          "        ContainerName: url-shortener-ecs-container" \
          '        ContainerPort: 8080' > appspec.yaml
          
          
          APPSPEC_JSON=$(jq -Rs . < appspec.yaml)

          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name "${{ secrets.CODEDEPLOY_APP }}" \
            --deployment-group-name "${{ secrets.CODEDEPLOY_GROUP }}" \
            --deployment-config-name "CodeDeployDefault.ECSCanary10Percent5Minutes" \
            --revision "revisionType=AppSpecContent, appSpecContent={content=$APPSPEC_JSON}" \
            --query "deploymentId" \
            --output text)

          echo "DeploymentId: $DEPLOYMENT_ID"
          aws deploy wait deployment-successful --deployment-id "$DEPLOYMENT_ID"

    - name: Health Checks
      run: |
          set -euo pipefail
          for i in {1..30}; do
            if curl -fsS https://ecs.zaitech.uk/healthz; then
              echo "Healthy!"
              exit 0
            fi
            echo "Not healthy yet, retrying... ($i/30)"
            sleep 10
          done
          echo "Service never became healthy"
          exit 1