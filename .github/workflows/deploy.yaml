name: Terraform Deploy

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'infra/**'
  push:
    branches: [ main ]
    paths:
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TF_VERSION: '1.6.0'

jobs:
  terraform:
    name: Terraform Plan and Apply
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./infra/envs/dev
    permissions:
      id-token: write
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Plan
        run: terraform plan -input=false

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -auto-approve -input=false

  deploy:
    name: Trigger CodeDeploy
    needs: terraform
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}


      - name: Build AppSpec and trigger CodeDeploy
        run: |
          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition url-shortener-ecs-task \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          cat > appspec.yaml << EOF
          version: 0.0
          Resources:
            - TargetService:
                Type: AWS::ECS::Service
                Properties:
                  TaskDefinition: $TASK_DEF
                  LoadBalancerInfo:
                    ContainerName: url-shortener-ecs-container
                    ContainerPort: 8080
          EOF

          cat appspec.yaml
          
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name "${{ secrets.CODEDEPLOY_APP }}" \
            --deployment-group-name "${{ secrets.CODEDEPLOY_GROUP }}" \
            --deployment-config-name "CodeDeployDefault.ECSCanary10Percent5Minutes" \
            --revision "revisionType=AppSpecContent,appSpecContent={content=$(cat appspec.yaml)}" \
            --query 'deploymentId' \
            --output text)

          echo "DeploymentId: $DEPLOYMENT_ID"

          echo "DeploymentId: $DEPLOYMENT_ID"

          set +e
          aws deploy wait deployment-successful --deployment-id "$DEPLOYMENT_ID"
          WAIT_RC=$?
          set -e

          if [ $WAIT_RC -ne 0 ]; then
            echo "CodeDeploy deployment FAILED. Details:"
            aws deploy get-deployment \
              --deployment-id "$DEPLOYMENT_ID" \
              --query 'deploymentInfo.{status:status,error:errorInformation,createTime:createTime,completeTime:completeTime,autoRollback:autoRollbackConfiguration,rollbackInfo:rollbackInfo}' \
              --output json

            echo "Recent ECS service events:"
            aws ecs describe-services \
              --cluster url-shortener-ecs-cluster \
              --services url-shortener-ecs-service \
              --query 'services[0].events[0:15].[createdAt,message]' \
              --output table
              
            echo "Target group health (blue/green):"
            for tg in url-shortener-ecs-blue-tg url-shortener-ecs-green-tg; do
              ARN=$(aws elbv2 describe-target-groups --names "$tg" --query 'TargetGroups[0].TargetGroupArn' --output text)
              echo "TG $tg => $ARN"
              aws elbv2 describe-target-health --target-group-arn "$ARN" --output table
            done

            exit 1
          fi
            

      - name: Health Checks
        run: |
          set -euo pipefail
          for i in {1..30}; do
            if curl -fsS https://ecs.zaitech.uk/healthz; then
              echo "Healthy!"
              exit 0
            fi
            echo "Not healthy yet, retrying... ($i/30)"
            sleep 10
          done
          echo "Service never became healthy"
          exit 1